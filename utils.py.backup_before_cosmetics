from datetime import datetime
from config import USDT_TRON_ADDRESS

def format_price(price: float) -> str:
    """Formatuje cenÄ™"""
    if price >= 1000:
        return f"{price:,.2f}"
    elif price >= 1:
        return f"{price:.4f}"
    else:
        return f"{price:.8f}"

def format_percent(value: float) -> str:
    """Formatuje procent"""
    emoji = "ğŸŸ¢" if value > 0 else "ğŸ”´" if value < 0 else "âšª"
    return f"{emoji} {value:+.2f}%"

def format_subscription_status(end_date: str, is_blocked: bool) -> str:
    """Formatuje status subskrypcji"""
    if is_blocked:
        return "âŒ ZABLOKOWANY"
    
    end = datetime.fromisoformat(end_date)
    now = datetime.now()
    
    if end < now:
        return "â° WYGASÅA"
    
    days_left = (end - now).days
    
    if days_left == 0:
        return "âš ï¸ WYGASA DZIÅš"
    elif days_left < 3:
        return f"âš ï¸ ZostaÅ‚o {days_left} dni"
    else:
        return f"âœ… Aktywna ({days_left} dni)"

def build_payment_instructions() -> str:
    """Instrukcja pÅ‚atnoÅ›ci"""
    return f"""ğŸ’³ INSTRUKCJA PÅATNOÅšCI

1ï¸âƒ£ WyÅ›lij 10 USDT (TRC20) na adres:
{USDT_TRON_ADDRESS}

2ï¸âƒ£ Po wysÅ‚aniu, wyÅ›lij botowi:
- Hash transakcji (TxID)
- Screenshot z portfela

3ï¸âƒ£ Admin aktywuje subskrypcjÄ™ w ciÄ…gu 24h

âš ï¸ WAÅ»NE:
- Tylko sieÄ‡ TRON (TRC20)
- DokÅ‚adnie 10 USDT
- Nie wysyÅ‚aj innych tokenÃ³w"""

def format_signal_message(symbol: str, ai_result: dict, price: float, change: float) -> str:
    """Formatuje wiadomoÅ›Ä‡ z sygnaÅ‚em"""
    signal = ai_result.get('signal', 'WAIT')
    confidence = ai_result.get('confidence', 0)
    reason = ai_result.get('reason', 'Brak uzasadnienia')
    analysis = ai_result.get('analysis', '')
    
    signal_emoji = {
        'LONG': 'ğŸŸ¢',
        'SHORT': 'ğŸ”´',
        'WAIT': 'âšª'
    }
    
    # UsuÅ„ znaki specjalne ktÃ³re mogÄ… powodowaÄ‡ bÅ‚Ä™dy parsowania Markdown
    reason_clean = reason.replace('*', '').replace('_', '').replace('`', '').replace('[', '').replace(']', '')
    analysis_clean = analysis.replace('*', '').replace('_', '').replace('`', '').replace('[', '').replace(']', '')
    
    message = f"""ğŸ¤– SYGNAÅ AI TRADER

ğŸ“Š Para: {symbol}
ğŸ’° Cena: {format_price(price)}
ğŸ“ˆ Zmiana 24h: {format_percent(change)}

{signal_emoji.get(signal, 'âšª')} SygnaÅ‚: {signal}
ğŸ¯ PewnoÅ›Ä‡: {confidence}%

ğŸ“ Uzasadnienie:
{reason_clean[:200]}

ğŸ” Analiza:
{analysis_clean[:300]}

âš ï¸ Disclaimer: To nie jest porada finansowa. Zawsze DYOR."""
    
    return message
